--- linux_patch141/include/net/esp.h	2022-05-03 15:54:26.323292451 +0800
+++ linux/include/net/esp.h	2022-05-03 16:58:42.964209562 +0800
@@ -4,6 +4,8 @@
 
 #include <linux/skbuff.h>
 
+#define ESP_SKB_FRAG_MAXSIZE (PAGE_SIZE << SKB_FRAG_PAGE_ORDER)
+
 struct ip_esp_hdr;
 
 static inline struct ip_esp_hdr *ip_esp_hdr(const struct sk_buff *skb)
--- linux_patch141/include/net/sock.h	2022-05-03 15:54:26.324292451 +0800
+++ linux/include/net/sock.h	2022-05-03 17:00:01.908186232 +0800
@@ -2583,6 +2583,8 @@
 extern __u32 sysctl_wmem_default;
 extern __u32 sysctl_rmem_default;
 
+/* On 32bit arches, an skb frag is limited to 2^15 */
+#define SKB_FRAG_PAGE_ORDER	get_order(32768)
 DECLARE_STATIC_KEY_FALSE(net_high_order_alloc_disable_key);
 
 static inline int sk_get_wmem0(const struct sock *sk, const struct proto *proto)
--- linux_patch141/net/core/sock.c	2022-05-03 15:56:02.966262799 +0800
+++ linux/net/core/sock.c	2022-05-03 17:00:34.754176524 +0800
@@ -2355,8 +2355,6 @@
 	}
 }
 
-/* On 32bit arches, an skb frag is limited to 2^15 */
-#define SKB_FRAG_PAGE_ORDER	get_order(32768)
 DEFINE_STATIC_KEY_FALSE(net_high_order_alloc_disable_key);
 
 /**
--- linux_patch141/net/ipv4/esp4.c	2022-05-03 15:56:02.879262826 +0800
+++ linux/net/ipv4/esp4.c	2022-05-03 17:02:15.289146771 +0800
@@ -277,6 +277,7 @@
 	struct page *page;
 	struct sk_buff *trailer;
 	int tailen = esp->tailen;
+	unsigned int allocsz;
 
 	/* this is non-NULL only with UDP Encapsulation */
 	if (x->encap) {
@@ -286,6 +287,10 @@
 			return err;
 	}
 
+	allocsz = ALIGN(skb->data_len + tailen, L1_CACHE_BYTES);
+	if (allocsz > ESP_SKB_FRAG_MAXSIZE)
+		goto cow;
+
 	if (!skb_cloned(skb)) {
 		if (tailen <= skb_tailroom(skb)) {
 			nfrags = 1;
--- linux_patch141/net/ipv6/esp6.c	2022-05-03 15:56:03.016262784 +0800
+++ linux/net/ipv6/esp6.c	2022-05-03 17:03:17.641128290 +0800
@@ -230,6 +230,11 @@
 	struct page *page;
 	struct sk_buff *trailer;
 	int tailen = esp->tailen;
+	unsigned int allocsz;
+
+	allocsz = ALIGN(skb->data_len + tailen, L1_CACHE_BYTES);
+	if (allocsz > ESP_SKB_FRAG_MAXSIZE)
+		goto cow;
 
 	if (!skb_cloned(skb)) {
 		if (tailen <= skb_tailroom(skb)) {
